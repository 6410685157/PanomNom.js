var v=class{constructor(o){this.canvas=o,this.ctx=this.canvas.getContext("2d"),this.queue=[],this.toLoad=0,this.loaded=0,this.onProgress=null}reset(){this.toLoad=0,this.loaded=0}addTileTask(o){this.queue.push(o),this.toLoad++}updateProgress(){let o=this.loaded*100/this.toLoad;this.onProgress&&this.onProgress(o)}processQueue(){if(this.updateProgress(),this.loaded===this.toLoad){this.resolve&&(this.resolve(!0),this.resolve=null);return}if(this.queue.length===0)return;let o=this.queue.shift(),e=new Image;e.decoding="async",e.addEventListener("load",()=>{this.loaded++,this.ctx.drawImage(e,0,0,e.naturalWidth,e.naturalHeight,o.x,o.y,512,512),this.processQueue(),e=null}),e.addEventListener("error",r=>{this.reject("NO_IMAGE"),e=null}),e.crossOrigin="",e.src=o.url}async process(){return this.toLoad=this.queue.length,this.loaded=0,new Promise((o,e)=>{this.resolve=o,this.reject=e;let r=Math.min(this.queue.length,1);for(let s=0;s<r;s++)this.processQueue()})}};var u=class{constructor(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.stitcher=new v(this.canvas)}async load(){}onProgress(o){this.stitcher.onProgress=o}};var n={};n.PADCHAR="=";n.ALPHA="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";n.makeDOMException=function(){var t,o;try{return new DOMException(DOMException.INVALID_CHARACTER_ERR)}catch(r){var e=new Error("DOM Exception 5");return e.code=e.number=5,e.name=e.description="INVALID_CHARACTER_ERR",e.toString=function(){return"Error: "+e.name+": "+e.message},e}};n.getbyte64=function(t,o){var e=n.ALPHA.indexOf(t.charAt(o));if(e===-1)throw n.makeDOMException();return e};n.decode=function(t){t=""+t;var o=n.getbyte64,e,r,s,a=t.length;if(a===0)return t;if(a%4!=0)throw n.makeDOMException();e=0,t.charAt(a-1)===n.PADCHAR&&(e=1,t.charAt(a-2)===n.PADCHAR&&(e=2),a-=4);var i=[];for(r=0;r<a;r+=4)s=o(t,r)<<18|o(t,r+1)<<12|o(t,r+2)<<6|o(t,r+3),i.push(String.fromCharCode(s>>16,s>>8&255,s&255));switch(e){case 1:s=o(t,r)<<18|o(t,r+1)<<12|o(t,r+2)<<6,i.push(String.fromCharCode(s>>16,s>>8&255));break;case 2:s=o(t,r)<<18|o(t,r+1)<<12,i.push(String.fromCharCode(s>>16));break}return i.join("")};n.getbyte=function(t,o){var e=t.charCodeAt(o);if(e>255)throw n.makeDOMException();return e};n.encode=function(t){if(arguments.length!==1)throw new SyntaxError("Not enough arguments");var o=n.PADCHAR,e=n.ALPHA,r=n.getbyte,s,a,i=[];t=""+t;var h=t.length-t.length%3;if(t.length===0)return t;for(s=0;s<h;s+=3)a=r(t,s)<<16|r(t,s+1)<<8|r(t,s+2),i.push(e.charAt(a>>18)),i.push(e.charAt(a>>12&63)),i.push(e.charAt(a>>6&63)),i.push(e.charAt(a&63));switch(t.length-h){case 1:a=r(t,s)<<16,i.push(e.charAt(a>>18)+e.charAt(a>>12&63)+o+o);break;case 2:a=r(t,s)<<16|r(t,s+1)<<8,i.push(e.charAt(a>>18)+e.charAt(a>>12&63)+e.charAt(a>>6&63)+o);break}return i.join("")};var f;function l(){return f||(f=new google.maps.StreetViewService,f)}async function b(t){let o=l();return new Promise((e,r)=>{o.getPanorama({pano:t},(s,a)=>{s?e(s):r(a)})})}async function S(t,o){let e=l(),r=new google.maps.LatLng(t,o);try{return await e.getPanorama({location:r,radius:50,source:"outdoor"})}catch(s){throw s}}function E(t,o){let e=t.split("?");return new URLSearchParams(e[1]).get(o)}function L(t){if(t=decodeURIComponent(t),t.indexOf("panoid")!=-1)return E(t,"panoid");if(t.indexOf("!1s")!=-1){let o=t.indexOf("!1s")+3,e=t.substr(o).indexOf("!");return t.substr(o,e)}else throw new Error("Can't find panorama id in specified URL")}var x=class extends u{constructor(){super();this.service=l(),this.zoom=1,this.metadata={}}async load(o,e){e===void 0&&(console.warn("No zoom provided, assuming 1"),e=1),this.zoom=e,this.panoId=o;let r=await b(o);this.metadata=r;let s=this.metadata.tiles.worldSize.width/this.metadata.tiles.worldSize.height,a,i;this.metadata.tiles.worldSize.width/512==32?(i=[1,2,4,8,16,32],a=[512,1024,2048,4096,8192,16384]):(i=[1,2,4,7,13,26],a=[416,832,1664,3328,6656,13312]),this.canvas.width=a[e],this.canvas.height=this.canvas.width/s;let h=this.metadata.tiles.tileSize.width,w=this.metadata.tiles.tileSize.height,p=i[e],g=p/s;for(let m=0;m<g;m++)for(let c=0;c<p;c++){let d=`https://geo0.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&panoid=${o}&output=tile&x=${c}&y=${m}&zoom=${e}&nbt&fover=2`;this.stitcher.addTileTask({url:d,x:c*h,y:m*w})}return await this.stitcher.process()}};async function C(t){let o=`https://www.google.com/maps/photometa/v1?authuser=0&hl=en&gl=uk&pb=!1m4!1smaps_sv.tactile!11m2!2m1!1b1!2m2!1sen!2suk!3m3!1m2!1e10!2s${t}!4m57!1e1!1e2!1e3!1e4!1e5!1e6!1e8!1e12!2m1!1e1!4m1!1i48!5m1!1e1!5m1!1e2!6m1!1e1!6m1!1e2!9m36!1m3!1e2!2b1!3e2!1m3!1e2!2b0!3e3!1m3!1e3!2b1!3e2!1m3!1e3!2b0!3e3!1m3!1e8!2b0!3e3!1m3!1e1!2b0!3e3!1m3!1e4!2b0!3e3!1m3!1e10!2b1!3e2!1m3!1e10!2b0!3e3`,r=await(await fetch(o)).text();return JSON.parse(r.substr(4))}var y=class extends u{constructor(){super();this.service=l(),this.zoom=1,this.metadata={}}async load(o,e){e===void 0&&(console.warn("No zoom provided, assuming 1"),e=1),this.zoom=e,this.panoId=o;let r=await C(o);this.metadata={tiles:{worldSize:{width:r[1][0][2][2][1],height:r[1][0][2][2][0]},tileSize:{width:r[1][0][2][3][1][1],height:r[1][0][2][3][1][0]}}};let s=this.metadata.tiles.worldSize.width/this.metadata.tiles.worldSize.height,a=[],i=[],h=1;for(let c of r[1][0][2][3][0])a.push(c[0][1]),i.push(h),h*=2;this.canvas.width=a[e],this.canvas.height=this.canvas.width/s;let w=this.metadata.tiles.tileSize.width,p=this.metadata.tiles.tileSize.height,g=i[e],A=g/s;for(let c=0;c<A;c++)for(let d=0;d<g;d++){let P=`https://lh3.ggpht.com/p/${o}=x${d}-y${c}-z${e}`;this.stitcher.addTileTask({url:P,x:d*w,y:c*p})}return await this.stitcher.process()}};export{y as GooglePhotoSphereLoader,x as GoogleStreetViewLoader,S as getIdByLocation,L as getIdFromURL};
