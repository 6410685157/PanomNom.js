var f=class{constructor(t){this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.queue=[],this.toLoad=0,this.loaded=0,this.onProgress=null}reset(){this.toLoad=0,this.loaded=0}addTileTask(t){this.queue.push(t),this.toLoad++}updateProgress(){let t=this.loaded*100/this.toLoad;this.onProgress&&this.onProgress(t)}processQueue(){if(this.updateProgress(),this.loaded===this.toLoad){this.resolve&&(this.resolve(!0),this.resolve=null);return}if(this.queue.length===0)return;let t=this.queue.shift(),e=new Image;e.decoding="async",e.addEventListener("load",()=>{this.loaded++,this.ctx.drawImage(e,0,0,e.naturalWidth,e.naturalHeight,t.x,t.y,512,512),this.processQueue(),e=null}),e.addEventListener("error",o=>{this.reject("NO_IMAGE"),e=null}),e.crossOrigin="",e.src=t.url}async process(){return this.toLoad=this.queue.length,this.loaded=0,new Promise((t,e)=>{this.resolve=t,this.reject=e;let o=Math.min(this.queue.length,1);for(let i=0;i<o;i++)this.processQueue()})}};var l=class{constructor(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.stitcher=new f(this.canvas)}async load(){}onProgress(t){this.stitcher.onProgress=t}};var p;function h(){return p||(p=new google.maps.StreetViewService,p)}async function y(s){let t=h();return new Promise((e,o)=>{t.getPanorama({pano:s},(i,r)=>{i?e(i):o(r)})})}async function L(s,t){let e=h(),o=new google.maps.LatLng(s,t);try{return await e.getPanorama({location:o,radius:50,source:"outdoor"})}catch(i){throw i}}function I(s,t){let e=s.split("?");return new URLSearchParams(e[1]).get(t)}function b(s){if(s=decodeURIComponent(s),s.indexOf("panoid")!=-1)return I(s,"panoid");if(s.indexOf("!1s")!=-1){let t=s.indexOf("!1s")+3,e=s.substr(t).indexOf("!");return s.substr(t,e)}else throw new Error("Can't find panorama id in specified URL")}var v=class extends l{constructor(){super();this.service=h(),this.zoom=1,this.metadata={}}async load(t,e){e===void 0&&(console.warn("No zoom provided, assuming 1"),e=1),this.zoom=e,this.panoId=t;let o=await y(t);this.metadata=o;let i=this.metadata.tiles.worldSize.width/this.metadata.tiles.worldSize.height,r,n;this.metadata.tiles.worldSize.width/512==32?(n=[1,2,4,8,16,32],r=[512,1024,2048,4096,8192,16384]):(n=[1,2,4,7,13,26],r=[416,832,1664,3328,6656,13312]),this.canvas.width=r[e],this.canvas.height=this.canvas.width/i;let m=this.metadata.tiles.tileSize.width,w=this.metadata.tiles.tileSize.height,u=n[e],g=u/i;for(let d=0;d<g;d++)for(let a=0;a<u;a++){let c=`https://geo0.ggpht.com/cbk?cb_client=maps_sv.tactile&authuser=0&hl=en&panoid=${t}&output=tile&x=${a}&y=${d}&zoom=${e}&nbt&fover=2`;this.stitcher.addTileTask({url:c,x:a*m,y:d*w})}return await this.stitcher.process()}};async function G(s){let t=`https://www.google.com/maps/photometa/v1?authuser=0&hl=en&gl=uk&pb=!1m4!1smaps_sv.tactile!11m2!2m1!1b1!2m2!1sen!2suk!3m3!1m2!1e10!2s${s}!4m57!1e1!1e2!1e3!1e4!1e5!1e6!1e8!1e12!2m1!1e1!4m1!1i48!5m1!1e1!5m1!1e2!6m1!1e1!6m1!1e2!9m36!1m3!1e2!2b1!3e2!1m3!1e2!2b0!3e3!1m3!1e3!2b1!3e2!1m3!1e3!2b0!3e3!1m3!1e8!2b0!3e3!1m3!1e1!2b0!3e3!1m3!1e4!2b0!3e3!1m3!1e10!2b1!3e2!1m3!1e10!2b0!3e3`,o=await(await fetch(t)).text();return JSON.parse(o.substr(4))}var S=class extends l{constructor(){super();this.service=h(),this.zoom=1,this.metadata={}}async load(t,e){e===void 0&&(console.warn("No zoom provided, assuming 1"),e=1),this.zoom=e,this.panoId=t;let o=await G(t);this.metadata={tiles:{worldSize:{width:o[1][0][2][2][1],height:o[1][0][2][2][0]},tileSize:{width:o[1][0][2][3][1][1],height:o[1][0][2][3][1][0]}}};let i=this.metadata.tiles.worldSize.width/this.metadata.tiles.worldSize.height,r=[],n=[],m=1;for(let a of o[1][0][2][3][0])r.push(a[0][1]),n.push(m),m*=2;this.canvas.width=r[e],this.canvas.height=this.canvas.width/i;let w=this.metadata.tiles.tileSize.width,u=this.metadata.tiles.tileSize.height,g=n[e],x=g/i;for(let a=0;a<x;a++)for(let c=0;c<g;c++){let P=`https://lh3.ggpht.com/p/${t}=x${c}-y${a}-z${e}`;this.stitcher.addTileTask({url:P,x:c*w,y:a*u})}return await this.stitcher.process()}};export{S as GooglePhotoSphereLoader,v as GoogleStreetViewLoader,L as getIdByLocation,b as getIdFromURL};
